version: 2

models:
  - name: int_orders__latest
    description: >
      Latest version of each order record.
      The model keeps only the most recent state per order_id,
      using load_date as the primary ordering and ingestion_ts as a secondary tie-breaker.
      This layer provides a clean current-state view for downstream marts.

    columns:
      - name: order_id
        description: Unique identifier of the order representing the current state
        tests:
          - not_null
          - unique

      - name: load_date
        description: Batch partition date used as primary ordering to identify the latest record per order
        tests:
          - not_null

      - name: ingestion_ts
        description: Ingestion timestamp used as secondary ordering when multiple records exist for the same load_date
        tests:
          - not_null

  - name: int_order_items__latest
    description: Current state of each order item based on load_date and ingestion_ts, preserving ingestion metadata for lineage and auditing.

    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - order_id
              - order_item_id

    columns:
      - name: order_id
        description: Order identifier.
        tests:
          - not_null

      - name: order_item_id
        description: Sequential item identifier within the order.
        tests:
          - not_null

      - name: product_id
        description: Product identifier.
        tests:
          - not_null

      - name: seller_id
        description: Seller identifier.
        tests:
          - not_null

      - name: price
        description: Item price.
        tests:
          - not_null

      - name: freight_value
        description: Freight cost for the item.
        tests:
          - not_null

      - name: load_date
        description: Batch partition date used to identify the latest record.
        tests:
          - not_null

      - name: ingestion_ts
        description: Ingestion timestamp used as secondary ordering for latest selection.
        tests:
          - not_null

  - name: int_customers__latest
    description: Latest version of each customer record based on load_date and ingestion_ts (current state per customer_id).

    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - customer_id

    columns:
      - name: customer_id
        description: Customer technical identifier used in transactional tables.
        tests:
          - not_null

      - name: customer_unique_id
        description: Identifier representing the real customer across multiple customer_id records.
        tests:
          - not_null

      - name: customer_zip_code_prefix
        description: ZIP code prefix used for geographic analysis.
        tests:
          - not_null

      - name: load_date
        description: Batch partition date used to determine the latest record.
        tests:
          - not_null

      - name: ingestion_ts
        description: Ingestion timestamp used as secondary ordering for latest selection.
        tests:
          - not_null

      - name: source_file
        description: Source file name used during ingestion (if available).

      - name: source_uri
        description: Source file URI/path used during ingestion (if available).

